@startuml
title Parser and Compiler Structure

package "Parser Module (dsl_parser.py)" {
    class DSLParser {
        - grammar: pyparsing expression
        --
        + __init__()
        + parse(dsl_string: str): dict
        - _setup_grammar()
        - _make_literal_node(tokens): dict
        - _make_call_node(tokens): dict
    }
    
    note right of DSLParser
        Parses DSL strings into
        dict-based AST nodes
        - Handles function calls
        - Handles literals (strings, numbers, booleans)
        - Returns dict with "type" and data
    end note
}

package "Compiler Module (compiler.py)" {
    class Compiler {
        + dsl_to_sklearn_estimator(dsl_string: str): estimator
        + compile_ast_to_estimator(node: dict, context: dict): estimator
        + eval_value(node: dict): Any
        + safe_kwargs_for(cls, kwargs: dict): dict
    }
    
    class ModelBuilder {
        + build_model(name: str, kw_nodes: dict, context: dict): estimator
    }
    
    class EnsembleBuilders {
        + build_vote(pos_nodes: list, kw_nodes: dict): VotingClassifier
        + build_stack(pos_nodes: list, kw_nodes: dict, context: dict): StackingClassifier
        + build_bag(pos_nodes: list, kw_nodes: dict, context: dict): BaggingClassifier
        + build_ada(pos_nodes: list, kw_nodes: dict, context: dict): AdaBoostClassifier
    }
    
    note right of Compiler
        Main compilation entry point
        - Converts AST dict to sklearn estimator
        - Routes to appropriate builder
    end note
    
    note right of ModelBuilder
        Builds individual sklearn models
        - Handles parameter validation
        - Applies special constraints (e.g., LR penalty/solver)
    end note
    
    note right of EnsembleBuilders
        Builds ensemble classifiers
        - Recursively compiles base estimators
        - Handles context propagation (e.g., voting mode)
    end note
}

package "Registry Module (registry.py)" {
    class MODEL_REGISTRY {
        + "LR": LogisticRegression
        + "SVM": SVC
        + "RF": RandomForestClassifier
        + "DT": DecisionTreeClassifier
        + "NB": GaussianNB
    }
    
    class ENSEMBLE_REGISTRY {
        + "vote": VotingClassifier
        + "stack": StackingClassifier
        + "bag": BaggingClassifier
        + "ada": AdaBoostClassifier
    }
}

package "sklearn" {
    class Estimator {
        <<interface>>
    }
    
    class LogisticRegression
    class SVC
    class VotingClassifier
    class StackingClassifier
    class BaggingClassifier
    class AdaBoostClassifier
}

' Relationships
DSLParser --> Compiler : "parse() returns dict AST"
Compiler --> ModelBuilder : "builds models"
Compiler --> EnsembleBuilders : "builds ensembles"
ModelBuilder --> MODEL_REGISTRY : "lookup model class"
EnsembleBuilders --> ENSEMBLE_REGISTRY : "lookup ensemble class"
ModelBuilder --> Estimator : "creates"
EnsembleBuilders --> Estimator : "creates"
LogisticRegression ..|> Estimator
SVC ..|> Estimator
VotingClassifier ..|> Estimator
StackingClassifier ..|> Estimator
BaggingClassifier ..|> Estimator
AdaBoostClassifier ..|> Estimator

@enduml
