@startuml
title Torque DSL - From Grammar to sklearn Estimator (Flow)

actor User

participant "Grammar.generate_dsl_from_grammar()" as Grammar
participant "DSLMapper (dsl_mapper.py)" as Mapper
participant "dsl_to_sklearn_estimator()\n(compiler.py)" as CompilerAPI
participant "compile_ast_to_estimator()" as CompileCore
participant "build_*()\n(build_model / build_vote / ...)" as Builders
participant "sklearn Estimator" as Est

== Optional: generate a random DSL program ==
User -> Grammar : generate_dsl_from_grammar("program")
Grammar --> User : dsl_string

== Map DSL string to AST ==
User -> Mapper : map(dsl_string)
Mapper -> Mapper : pyparsing grammar\n& actions
Mapper --> User : ast_root (CallNode/LiteralNode dict)

== Direct compile helper ==
User -> CompilerAPI : dsl_to_sklearn_estimator(dsl_string)
CompilerAPI -> Mapper : map_dsl_to_ast(dsl_string)
Mapper --> CompilerAPI : ast_root

== Compile AST to sklearn estimator ==
CompilerAPI -> CompileCore : compile_ast_to_estimator(ast_root)
CompileCore -> Builders : depending on node.name\n(e.g. vote/stack/bag/ada/LR/SVM/...)
Builders -> "MODEL_REGISTRY / ENSEMBLE_REGISTRY" : lookup sklearn classes
Builders --> CompileCore : concrete sklearn estimator
CompileCore --> CompilerAPI : estimator
CompilerAPI --> User : sklearn estimator (unfitted)

@enduml