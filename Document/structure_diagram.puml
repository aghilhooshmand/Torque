@startuml
title Torque DSL - Grammar, Mapper, Compiler (Structure)

package "grammar.py" as GrammarModule {
  class Grammar {
    +GRAMMAR : dict
    +generate_dsl_from_grammar(rule="program", max_depth=10, current_depth=0) : str
  }
}

package "dsl_mapper.py" as MapperModule {
  class DSLMapper {
    +__init__() 
    +map(dsl_string : str) : dict
    -_setup_grammar()
    -_make_literal_node(tokens)
    -_make_call_node(tokens)
    --
    -grammar  ' pyparsing expression
  }

  class "CallNode (dict)" as CallNode {
    type = "call"
    name : str
    pos  : list   ' positional args
    kw   : dict   ' keyword args
  }

  class "LiteralNode (dict)" as LiteralNode {
    type  = "literal"
    value : Any
  }

  MapperModule ..> CallNode : produces
  MapperModule ..> LiteralNode : produces

  note right of DSLMapper
    Uses pyparsing to map a DSL string
    into dict-based AST nodes (CallNode, LiteralNode).
  end note
}

package "compiler.py" as CompilerModule {
  class Compiler {
    +dsl_to_sklearn_estimator(dsl_string : str) : Estimator
    +compile_ast_to_estimator(node : dict, context : dict=None) : Estimator
    +eval_value(node : dict) : Any
    +build_model(name : str, kw_nodes : dict, context : dict=None) : Estimator
    +build_vote(pos_nodes : list, kw_nodes : dict) : VotingClassifier
    +build_stack(pos_nodes : list, kw_nodes : dict, context : dict=None) : StackingClassifier
    +build_bag(pos_nodes : list, kw_nodes : dict, context : dict=None) : BaggingClassifier
    +build_ada(pos_nodes : list, kw_nodes : dict, context : dict=None) : AdaBoostClassifier
    +safe_kwargs_for(cls, kwargs : dict) : dict
  }

  interface "MODEL_REGISTRY" as ModelRegistry
  interface "ENSEMBLE_REGISTRY" as EnsembleRegistry

  Compiler ..> CallNode : reads
  Compiler ..> LiteralNode : reads
  Compiler ..> ModelRegistry : uses
  Compiler ..> EnsembleRegistry : uses
}

' Cross-module relationships
GrammarModule ..> MapperModule : generates DSL text for
MapperModule ..> CompilerModule : AST input to
CompilerModule ..> "sklearn estimators" : creates

@enduml