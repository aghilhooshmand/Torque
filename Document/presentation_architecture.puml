@startuml
allowmixing

title Torque DSL - System Architecture

package Grammar {
  rectangle "Grammar Definition\n(grammar.py)" as Grammar
  rectangle "Production Rules" as Rules
  rectangle "Model Types" as Models
  rectangle "Ensemble Types" as Ensembles
  
  Grammar --> Rules
  Rules --> Models
  Rules --> Ensembles
  
  note right of Grammar
    **Purpose:** Defines DSL syntax
    and production rules
    
    **Features:**
    - Context-free grammar
    - Supports grammatical evolution
    - Generates valid DSL strings
  end note
  
  note right of Models
    Base Models:
    - LR (LogisticRegression)
    - SVM (SVC)
    - RF (RandomForest)
    - DT (DecisionTree)
    - NB (GaussianNB)
  end note
  
  note right of Ensembles
    Ensemble Methods:
    - vote (VotingClassifier)
    - stack (StackingClassifier)
    - bag (BaggingClassifier)
    - ada (AdaBoostClassifier)
  end note
}

package Mapper {
  rectangle "DSL Mapper\n(dsl_mapper.py)" as Mapper
  rectangle "PyParsing Grammar" as PyGrammar
  rectangle "AST Nodes" as AST
  rectangle "Call Nodes" as CallNodes
  rectangle "Literal Nodes" as LiteralNodes
  
  Mapper --> PyGrammar
  PyGrammar --> AST
  AST --> CallNodes
  AST --> LiteralNodes
  
  note right of Mapper
    **Purpose:** Maps Torque DSL
    commands to AST for scikit-learn
    
    **Technology:** PyParsing library
    
    **Process:**
    1. Tokenizes DSL command
    2. Matches grammar rules
    3. Builds dict-based AST nodes
  end note
  
  note right of CallNodes
    Function calls:
    - Model calls: LR(C=1.0)
    - Ensemble calls: vote(model1, model2)
    - Nested structures
  end note
  
  note right of LiteralNodes
    Literal values:
    - Numbers: 1.0, 100
    - Strings: "rbf", "hard"
    - Booleans: True, False
  end note
}

package Compiler {
  rectangle "AST Compiler\n(compiler.py)" as Compiler
  rectangle "Model Builder" as ModelBuilder
  rectangle "Ensemble Builder" as EnsembleBuilder
  rectangle "Registry Lookup" as Registry
  rectangle "sklearn Estimators" as Estimators
  
  Compiler --> ModelBuilder
  Compiler --> EnsembleBuilder
  ModelBuilder --> Registry
  EnsembleBuilder --> Registry
  ModelBuilder --> Estimators
  EnsembleBuilder --> Estimators
  
  note right of Compiler
    **Purpose:** Compiles AST
    to scikit-learn estimators
    
    **Process:**
    1. Traverses AST nodes
    2. Evaluates parameters
    3. Validates constraints
    4. Instantiates sklearn objects
  end note
  
  note right of ModelBuilder
    Builds individual models:
    - Validates parameters
    - Handles constraints
    (e.g., LR penalty/solver)
    - Applies safe kwargs
  end note
  
  note right of EnsembleBuilder
    Builds ensembles:
    - Recursively compiles
      base estimators
    - Handles context
      propagation
    - Manages voting modes
  end note
  
  note right of Registry
    Model Registry:
    Maps DSL names to
    sklearn classes
    
    Ensemble Registry:
    Maps ensemble types
    to sklearn classes
  end note
}

' Main flow
Grammar --> Mapper : DSL string
Mapper --> Compiler : AST (dict)
Compiler --> Estimators : sklearn Estimator objects

@enduml
