@startuml
title Parser and Compiler Sequence Diagram

actor User

participant "DSLParser" as Parser
participant "dsl_to_sklearn_estimator()" as CompilerAPI
participant "compile_ast_to_estimator()" as Compiler
participant "build_model()" as ModelBuilder
participant "build_vote()\nbuild_stack()\nbuild_bag()\nbuild_ada()" as EnsembleBuilder
participant "MODEL_REGISTRY\nENSEMBLE_REGISTRY" as Registry
participant "sklearn Estimator" as Estimator

== Parse DSL String to AST ==
User -> Parser : parse(dsl_string)
activate Parser

Parser -> Parser : _setup_grammar()\n(if first call)
Parser -> Parser : grammar.parseString(dsl_string)
Parser -> Parser : _make_call_node() or\n_make_literal_node()

Parser --> User : ast_node (dict)\n{type: "call", name: "...", pos: [...], kw: {...}}
deactivate Parser

== Compile DSL String to Estimator ==
User -> CompilerAPI : dsl_to_sklearn_estimator(dsl_string)
activate CompilerAPI

CompilerAPI -> Parser : parse_dsl_to_ast(dsl_string)
activate Parser
Parser --> CompilerAPI : ast_node (dict)
deactivate Parser

CompilerAPI -> Compiler : compile_ast_to_estimator(ast_node)
activate Compiler

alt Node is a Model (LR, SVM, RF, DT, NB)
    Compiler -> ModelBuilder : build_model(name, kw_nodes, context)
    activate ModelBuilder
    
    ModelBuilder -> ModelBuilder : eval_value() for each kw arg
    ModelBuilder -> Registry : MODEL_REGISTRY[name]
    Registry --> ModelBuilder : sklearn class
    ModelBuilder -> ModelBuilder : safe_kwargs_for()\n(validate parameters)
    ModelBuilder -> ModelBuilder : Apply special rules\n(e.g., LR penalty/solver)
    ModelBuilder -> Estimator : cls(**kw)
    Estimator --> ModelBuilder : sklearn estimator instance
    ModelBuilder --> Compiler : estimator
    deactivate ModelBuilder

else Node is Ensemble (vote, stack, bag, ada)
    Compiler -> EnsembleBuilder : build_* (pos_nodes, kw_nodes, context)
    activate EnsembleBuilder
    
    loop For each base estimator in pos_nodes
        EnsembleBuilder -> Compiler : compile_ast_to_estimator(child_node, context)
        activate Compiler
        Compiler --> EnsembleBuilder : base_estimator
        deactivate Compiler
    end
    
    EnsembleBuilder -> EnsembleBuilder : eval_value() for options
    EnsembleBuilder -> Registry : ENSEMBLE_REGISTRY[name]
    Registry --> EnsembleBuilder : sklearn ensemble class
    EnsembleBuilder -> EnsembleBuilder : safe_kwargs_for()\n(validate parameters)
    EnsembleBuilder -> Estimator : EnsembleClass(estimators=[...], **options)
    Estimator --> EnsembleBuilder : sklearn ensemble instance
    EnsembleBuilder --> Compiler : ensemble estimator
    deactivate EnsembleBuilder
end

Compiler --> CompilerAPI : sklearn estimator (unfitted)
deactivate Compiler
CompilerAPI --> User : sklearn estimator (unfitted)
deactivate CompilerAPI

@enduml
